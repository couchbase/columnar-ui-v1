<div id="js_servers" class="servers" data-ng-class="{'rebalancing': mnServersController.mnServersState.rebalancing}">
  <h1>Servers</h1>
  <div
    class="warning_message failover_warning"
    ng-repeat="warning in mnServersController.mnPoolDefault.value.failoverWarnings"
    ng-show="warning && warning != 'failoverNeeded'">
      <span>Fail Over Warning: <span class="warning-text">{{warning | formatFailoverWarnings}}</span></span>
  </div>
  <div
    class="warning_message"
    style="color:red;"
    id="js_rebalance_during_sample_load"
    ng-show="mnServersController.mnServersState.showWarningMessage">
      Warning: Rebalance is not available until data loading is completed!
  </div>
  <div
    id="auto_failover_count_container"
    class="warning_message"
    ng-show="mnServersController.mnServersState.autoFailoverSettingsCount > 0">
      A server was automatically failed over
    <a
      class="auto_failover_count_reset edit_btn when-roadmin-hide-me"
      ng-hide="mnServersController.mnPoolDefault.value.isROAdminCreds"
      ng-click="mnServersController.mnServersState.resetAutoFailOverCount()"
      mn-spinner="mnServersController.mnServersState.resetQuotaLoading">
      <span>Reset Quota</span>
    </a>
  </div>
  <div class="shadow_box">
    <div class="header_2">
      <span class="staleness-notice">Difficulties communicating with the cluster; displaying cached information!</span>
      <a
        class="btn_1 when-enterprise when-roadmin-avoid-me"
        ui-sref="app.admin.groups"
        id="js_server_groups_tab"
        ng-hide="mnServersController.isServerGroupsDisabled()"><span>Server Groups</span></a>
      <a
        class="add_button btn_1 when-roadmin-hide-me casper_servers_add_popup"
        ng-hide="mnServersController.isAddServerDisabled()"
        ng-click="mnServersController.addServer()"><span>Add Server</span></a>
      <a
        class="rebalance_button btn_1 when-roadmin-hide-me"
        ng-hide="mnServersController.isRebalanceDisabled()"
        ng-click="mnServersController.postRebalance()"><span>Rebalance</span></a>
      <a
        class="stop_rebalance_button btn_1 when-roadmin-hide-me"
        ng-hide="mnServersController.stopRebalanceDisabled()"
        ng-click="mnServersController.stopRebalance()">
        <span ng-show="mnServersController.mnServersState.tasks.isSubtypeGraceful">Stop Fail Over</span>
        <span ng-show="!mnServersController.mnServersState.tasks.isSubtypeGraceful">Stop Rebalance</span>
      </a>
      <a
        class="stop_recovery_button btn_1 when-roadmin-hide-me"
        ng-click="mnServersController.onStopRecovery()"
        ng-hide="mnServersController.stopRecoveryDisabled()"><span>Stop Recovery</span></a>
      <ul class="tabs">
        <li class="tab_left">
          <a
            ui-sref="app.admin.servers({ list: 'active' })"
            ui-sref-active="selected">Active Servers</a>
        </li>
        <li class="tab_right" id="rebalance_tab">
          <a
            class="casper_servers_pending_rebalance_tab"
            ui-sref="app.admin.servers({ list: 'pending' })"
            ui-sref-active="selected">Pending Rebalance</a>
            <span
              class="badge"
              data-ng-show="mnServersController.mnServersState.showPendingBadge"><span>
                {{mnServersController.mnServersState.pendingLength}}
              </span>
            </span>
        </li>
      </ul>
    </div>
    <div class="panes">
      <div
        class="servers_list"
        mn-spinner="mnServersController.viewLoading"
        min-height="91px">
        <table class="list" style="width:100%" mn-sortable-table="hostname">
          <colgroup>
            <col style="width:19%">
            <col style="width:9%">
            <col style='{%= mnServersController.mnServersState.isGroupsAvailable ? "width: 7%;" : "width: 0px;" %}'>
            <col style="width:7%">
            <col style="width:8%">
            <col style="width:8%">
            <col style="width:8%">
            <col style="width:8%">
            <col style="width:4%">
            <col style="width:22%">
          </colgroup>
          <tbody>
            <tr>
              <th mn-sortable-title="hostname" class="node_name" style="text-align:left;">Server Node Name</th>
              <th></th>
              <th mn-sortable-title="group" style='{{ mnServersController.mnServersState.isGroupsAvailable ? "text-align: center!important;" : "width: 0px;" }}'>{{ mnServersController.mnServersState.isGroupsAvailable ? "Group" : " " }}</th>
              <th mn-sortable-title="services">Services</th>
              <th>RAM Usage</th>
              <th>Swap Usage</th>
              <th>CPU Usage</th>
              <th>Data/Disk Usage</th>
              <th style="text-indent:8px;white-space: nowrap;">Items (Active / Replica)</th>
              <th></th>
            </tr>
          </tbody>
          <tbody ng-repeat="node in mnServersController.mnServersState.currentNodes | orderBy:orderBy:invert track by node.otpNode">
            <tr
              ng-if="mnServersController.isReAddPossible(node)"
              class="add_back_row when-roadmin-avoid-me">
              <td colspan="10">
                <span
                  class="add_back_btn"
                  ng-click="mnServersController.reAddNode('full', node.otpNode)">
                    <span>Full Recovery</span>
                </span>
                <span
                  class="add_back_btn only-when-30"
                  ng-click="mnServersController.reAddNode('delta', node.otpNode)">
                    <span>Delta Recovery</span>
                </span>
                <span class="add_b_message">
                  This server is now reachable. Do you want to add it back to the cluster on the next rebalance?
                </span>
              </td>
            </tr>
            <tr class="server_row " id="{{node.otpNode | mnMakeSafeForCSS}}">
              <td class="node_name ellipsis">
                <a ng-if="!mnServersController.isNodeUnhealthy(node)"
                   ng-click="mnServersController.toggleDetails(node.hostname)"
                   class="{{'casper_open_cluster_' + node.otpNode | mnMakeSafeForCSS}}"
                   title="Show Server Node info">
                    <ins class="expander" ng-class="{closed: !mnServersController.isDetailsOpened(node.hostname)}"></ins>
                </a>
                <span ng-if="mnServersController.showInactiveNodeHostname(node)">
                  {{node.hostname | mnStripPortHTML:mnServersController.mnServersState.nodes.allNodes}}
                </span>
                <span ng-if="mnServersController.isNodeUnhealthy(node)">
                  {{node.hostname}}
                </span>
                <a ng-if="mnServersController.showActiveNodeHostname(node)"
                   title="{{'View Analytics for ' + node.hostname}}"
                   ui-sref="app.admin.analytics.list.graph({statsHostname: node.hostname})">
                  {{node.hostname | mnStripPortHTML:mnServersController.mnServersState.nodes.allNodes}}
                </a>
              </td>
              <td
                class="servers_icons  {{'dynamic_' + node.status + ' dynamic_' + node.clusterMembership}}"
                ng-class="{dynamic_lastActive: mnServersController.isLastActiveData()}">
              </td>
              <td>
                <div class="ellipsis" title="{{node.group}}">{{node.group}}</div>
              </td>
              <td style="text-align: left;">
                <div ng-repeat="service in node.services | orderBy:'toString()'">
                  {{service | mnFormatServices}}
                </div>
              </td>

              <td class="ram" mn-vertical-bar="" conf="mnServersController.getRamUsageConf(node)">
              </td>
              <td class="ram" mn-vertical-bar="" conf="mnServersController.getSwapUsageConf(node)">
              </td>
              <td class="ram" mn-vertical-bar="" conf="mnServersController.getCpuUsageConf(node)">
              </td>
              <td class="ram">
                <span ng-if="!mnServersController.isDataDiskUsageAvailable(node)">
                  N/A
                </span>
                <span ng-if="mnServersController.isDataDiskUsageAvailable(node)">
                  {{mnServersController.couchDataSize(node) | mnFormatQuantity}} / <br>{{mnServersController.couchDiskUsage(node) | mnFormatQuantity}}
                </span>
              </td>
              <td class="rep" style="padding-left:0;padding-right:0;">
                {{node.interestingStats.curr_items || 0 | mnFormatQuantity:1000:' ' }}/<br>{{node.interestingStats.vb_replica_curr_items || 0 | mnFormatQuantity:1000:' ' }}
              </td>
              <td
                ng-if="mnServersController.showRebalanceProgressPerItem()"
                class="actions">
                  <span class="usage_info">{{mnServersController.getRebalanceProgress(node) | mnTruncateTo3Digits}} % Complete</span>
                  <span class="server_usage"><span style="width: {{mnServersController.getRebalanceProgress(node) | mnTruncateTo3Digits}}%"></span></span>
              </td>
              <td
                ng-if="mnServersController.showPendingAddControls(node)"
                class="actions with_state_message">
                  <span class="state_message">Pending Add</span>
                  <a
                    ng-hide="mnServersController.mnPoolDefault.value.isROAdminCreds"
                    class="list_button btn_cancel eject_server when-roadmin-avoid-me"
                    ng-class="{dynamic_disabled: mnServersController.mnServersState.tasks.inRecoveryMode}"
                    ng-click="!mnServersController.mnServersState.tasks.inRecoveryMode && mnServersController.ejectServer(node)"><span>Cancel</span></a>
              </td>
              <td
                ng-if="mnServersController.showPendingRecoveryControls(node)"
                class="actions with_state_message">
                  <span class="state_message">Pending {{node.recoveryType}} recovery</span>
                  <a
                    ng-hide="mnServersController.mnPoolDefault.value.isROAdminCreds"
                    class="list_button btn_cancel eject_server when-roadmin-avoid-me"
                    ng-class="{dynamic_disabled: mnServersController.mnServersState.tasks.inRecoveryMode}"
                    ng-click="!mnServersController.mnServersState.tasks.inRecoveryMode && mnServersController.cancelFailOverNode(node.otpNode)"><span>Cancel</span></a>
              </td>
              <td
                ng-if="mnServersController.showPendingRemovalControls(node)"
                class="actions with_state_message">
                  <span class="state_message">Pending Removal</span>
                  <a
                    ng-hide="mnServersController.mnPoolDefault.value.isROAdminCreds"
                    class="list_button btn_cancel remove_from_list when-roadmin-avoid-me"
                    ng-class="{dynamic_disabled: mnServersController.mnServersState.tasks.inRecoveryMode}"
                    ng-click="!mnServersController.mnServersState.tasks.inRecoveryMode && mnServersController.cancelEjectServer(node)"><span>Cancel</span></a>
              </td>
              <td
                ng-if="mnServersController.showFailedOverControls(node)"
                class="actions">
                  <a
                    ng-hide="mnServersController.mnPoolDefault.value.isROAdminCreds"
                    class="list_button eject_server when-roadmin-avoid-me casper_servers_remove_popup"
                    ng-class="{dynamic_disabled: mnServersController.disableRemoveBtn()}"
                    ng-click="!mnServersController.disableRemoveBtn() && mnServersController.ejectServer(node)"><span>Remove</span></a>
                  <a
                    ng-hide="mnServersController.mnPoolDefault.value.isROAdminCreds"
                    class="list_button failover_server when-roadmin-avoid-me casper_servers_failover_popup"
                    ng-class="{dynamic_disabled: mnServersController.isFailOverDisabled()}"
                    ng-click="!mnServersController.isFailOverDisabled() && mnServersController.failOverNode(node)"><span>Fail Over</span></a>
                  <span class="failed_over_message">Failed Over: Pending Removal</span>
              </td>
            </tr>
            <tr ng-if="mnServersController.isDetailsOpened(node.hostname)" ui-view="details">
            </tr>
          </tbody>

          <tbody ng-if="!mnServersController.mnServersState.currentNodes.length">
            <tr class="server_row rebalance_empty">
              <td colspan="10">There are no servers pending rebalance.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
