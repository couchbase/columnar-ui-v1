<mn-element-cargo depot="actions">
  <div class="header-controls resp-sml">
    <a
       uiSref="app.admin.replications"
       class="resp-hide-sml">
      <span class="icon fa-arrow-left"></span> BACK
    </a>
  </div>
</mn-element-cargo>

<form
   [formGroup]="form.group"
   (submit)="form.submit.next()"
   class="forms">
  <div class="row flex-left items-stretch resp-flex-column-med margin-bottom-2">
    <div class="width-8">
      <div
         class="error"
         [hidden]="!(postCreateReplication.error | async)?._">
        {{(postCreateReplication.error | async)?._}}
      </div>
      <div
         class="error error-field"
         [hidden]="!(postCreateReplication.error | async)?.fromBucket">
        {{(postCreateReplication.error | async)?.fromBucket}}
      </div>
      <div
         class="error error-field"
         [hidden]="!(postCreateReplication.error | async)?.toCluster">
        {{(postCreateReplication.error | async)?.toCluster}}
      </div>
      <div
         class="error error-field"
         [hidden]="!(postCreateReplication.error | async)?.toBucket">
        {{(postCreateReplication.error | async)?.toBucket}}
      </div>

      <div class="formrow row flex-left items-stretch resp-flex-column-s">
        <div class="column">
          <label for="replication_from_bucket" class="nowrap">Replicate From Bucket</label>
          <select
             formControlName="fromBucket">
            <option value="" disabled="true">
              select a bucket
            </option>
            <option *ngFor="let v of (bucketsMembaseEphemeral | async)" [ngValue]="v.name">
              {{v.name}}
            </option>
          </select>
        </div>

        <div class="column row">
          <span class="icon fa-angle-right text-superbig grayblack-2"></span>
        </div>

        <div class="column">
          <label for="replication_to_cluster">Remote Cluster</label>
          <select formControlName="toCluster">
            <option value="" disabled="true">
              Pick remote cluster
            </option>
            <option *ngFor="let v of (remoteClusters | async)" [ngValue]="v.name">
              {{v.name}}
            </option>
          </select>
        </div>

        <div class="column">
          <label for="replication_to_bucket">Remote Bucket</label>
          <input
             id="replication_to_bucket"
             formControlName="toBucket"
             type="text"
             autocorrect="off"
             spellcheck="false"
             autocapitalize="off"
             class="fix-width-4 resp-sml">
        </div>
      </div>

      <div
         class="zero-content"
         [hidden]="!form.group.get('fromBucket').value">
        The bucket <em>{{form.group.get('fromBucket').value}}</em>
        will be replicated to <em>{{form.group.get('toCluster').value}}</em>.
        Missing targets on the remote will be ignored and that data
        will not be replicated.
      </div>

      <div class="row flex-left margin-bottom-half margin-top-1">
        <label class="toggle-control margin-0">
          <input
             formControlName="collectionsExplicitMapping"
             id="collections_explicit_mapping"
             type="checkbox">
          <span class="toggle-control-body"></span>
        </label>
        <span class="text-small margin-left-half">
          Specify scopes, collections, and mapping
        </span>
      </div>

      <div
         class="margin-bottom-1-5"
         [hidden]="!form.group.get('collectionsExplicitMapping').value">
        <div
           class="error error-field"
           [hidden]="!(postCreateReplication.error | async)?.colMappingRules">
          {{(postCreateReplication.error | async)?.colMappingRules}}
        </div>

        <div class="row">
          <h4>Scopes and Collections to Replicate</h4>
          <mn-input-filter
             class="inline"
             [group]="scopesFilter.group"
             placeholder="filter scopes">
          </mn-input-filter>
        </div>
        <div class="cbui-table">
          <div class="cbui-table-header">
            <span class="cbui-table-cell flex-grow-3">
              <span
                 mn-sortable-title="name"
                 sort-by-default="true"
                 class="sorter indent-1">
                scope
              </span>
            </span>
          </div>
          <div
             *ngFor="let scope of (scopesPaginator.page | async);">
            <mn-xdcr-add-rep-scope
               style="display: block;"
               [group]="explicitMappingGroup"
               [item]="scope"
               [rulesHolder]="explicitMappingRules">
            </mn-xdcr-add-rep-scope>
          </div>
        </div>
        <ngb-pagination
           *ngIf="(scopesPaginator.values | async)?.size && (scopes | async)?.length"
           [page]="(scopesPaginator.values | async)?.page"
           [maxSize]="5"
           [pageSize]="(scopesPaginator.values | async)?.size"
           [collectionSize]="(scopes | async)?.length"
           (pageChange)="scopesPaginator.group.patchValue({page:$event})">
          <ng-template ngbPaginationPrevious>&#60; prev</ng-template>
          <ng-template ngbPaginationNext>next &#62;</ng-template>
        </ngb-pagination>
      </div>

      <div class="row flex-left margin-bottom-half">
        <label class="toggle-control margin-0">
          <input
             formControlName="collectionsMigrationMode"
             id="collections_migration_mode"
             type="checkbox">
          <span class="toggle-control-body"></span>
        </label>
        <span class="text-small margin-left-half">Enable Collections Migration Mode </span>

        <span
           class="fa-stack icon-info sup"
           ngbTooltip="Something wise here..."
           placement="top">
          <span class="icon fa-circle-thin fa-stack-2x"></span>
          <span class="icon fa-info fa-stack-1x"></span>
        </span>
      </div>

      <div
         [formGroup]="explicitRuleBasedMappingGroup"
         [hidden]="!form.group.get('collectionsMigrationMode').value"
         class="margin-bottom-1-5">
        <div class="formrow row flex-left items-stretch resp-flex-column-s">
          <div class="column width-4">
            <label for="migration_from_collection">Replicate From Collection</label>
            <input
               class="width-12"
               id="migration_from_collection"
               formControlName="migrationKey"
               placeholder="Expression for source default collection"
               type="text"
               autocorrect="off"
               spellcheck="false"
               autocapitalize="off">
          </div>
          <div class="column width-4">
            <label for="migration_to_collection">Replicate To Collection</label>
            <input
               class="width-12"
               id="migration_to_collection"
               formControlName="migrationTarget"
               placeholder="Expression for specific target collection"
               type="text"
               autocorrect="off"
               spellcheck="false"
               autocapitalize="off">
          </div>
          <button
             class="margin-top-1-5 inline"
             type="button"
             (click)="addExplicitRuleBasedMappings.next()">Save Mapping</button>

          <div
             class="error error-field"
             [hidden]="!(postCreateReplication.error | async)?.colMappingRules">
            {{(postCreateReplication.error | async)?.colMappingRules}}
          </div>
        </div>
      </div>

      <mn-xdcr-filter
         [bucket]="form.group.get('fromBucket').value"
         [group]="form.group"
         *ngIf="(isEnterprise | async)"></mn-xdcr-filter>

      <mn-xdcr-settings
         [group]="form.group"
         style="display:block;"
         class="margin-top-1-5"
         [type]="form.group.get('type').value"></mn-xdcr-settings>
    </div>

    <div
       style="border-left: 1px solid #d1d1d1; margin: 0 16px; flex-basis: 1;"
       class="resp-hide-med">&nbsp;</div>

    <div class="width-4">
      <h4>Mapping Rules</h4>
      <div *ngFor="let item of getExplicitMappingRulesKeys()"
         class="row padding-quarter margin-top-half margin-bottom-quarter grayblack-bg-7 text-small">
        <span>
          {{item}} &gt; {{explicitMappingRules[item] || 'null'}}
        </span>
        <a
           (click)="delExplicitMappingRules(item)"
           class="x-close-sml">
          X</a>
      </div>

      <div *ngFor="let item of getExplicitRuleBasedMappingsKeys()"
         class="row padding-quarter margin-quarter label neutral">
        <span>
          {{item}} --> {{explicitRuleBasedMappings[item]}}
        </span>
        <a (click)="delExplicitRuleBasedMappings(item)">X</a>
      </div>
    </div>
  </div>

  <footer class="footer-save">
    <button type="submit" class="margin-right-2">Save Replication</button>
    <a class="text-medium" uiSref="app.admin.replications">Cancel/Reset</a>
  </footer>
</form>
